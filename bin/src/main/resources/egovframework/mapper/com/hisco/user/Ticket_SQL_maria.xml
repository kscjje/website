<?xml version="1.0" encoding="UTF-8"?><!--
	수정일                 수정자                          수정내용
  =========     =======    =================================================
  2020.10.29   	김희택     	 	티켓 정보
-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hisco.intrfc.ticket.mapper.TicketMapper">

	<select id="selectExbtTicketDetail" resultType="cMap">
			SELECT /* TicketDAO.selectTicketDetail */
				T.*,
				(SELECT COUNT(*) FROM EXBT_TICKET_CHKININFO H WHERE H.COMCD=#{comcd} AND H.EXBT_PARTCD=T.PART_CD AND H.EXBT_TICKET_NO=T.TICKET_NO) AS CHK_CNT,
				(SELECT TICKET_PRN_NOTICE FROM Partcd_SystemPref WHERE COMCD=#{comcd} AND PART_CD=T.PART_CD) AS TICKET_DESC
			FROM (
					SELECT
						'EXBT' AS GUBUN,
						M.EXBT_RSVN_IDX AS RSVN_IDX,
						M.EXBT_RSVN_NO AS RSVN_NO,
						M.EXBT_VISTNMPR AS VISIT_NUM,
						M.EXBT_APPDATE AS YMD,
						M.EXBT_APPTYPE AS APPTYPE,
						R.EXBT_STIME AS S_TIME,
						R.EXBT_ETIME AS E_TIME,
						CASE WHEN B.EXBT_TYPE='1001' THEN
							 (SELECT C.CD_NM  FROM COT_GRPCD C WHERE C.GRP_CD='SM_EXBT_TYPE' AND C.CD=B.EXBT_TYPE) ELSE B.EXBT_NAME  END AS TITLE,
						B.EXBT_TICKET_NOTICE AS NOTICE_TXT,
						B.EXBT_PARTCD AS PART_CD,
						B.EXBT_TYPE AS TYPE_CD,
						M.EXBT_RSVN_CUSTNM AS CUST_NM,
						
						<!-- for Tibero CRYPTO.Decrypt_ARIA(M.EXBT_HP ,#{dbEnckey}) AS HP,
						CRYPTO.Decrypt_ARIA(M.EXBT_EMAIL ,#{dbEnckey}) AS CUST_EMAIL, -->
						M.EXBT_HP    AS HP,
						M.EXBT_EMAIL AS CUST_EMAIL, 
						
						(SELECT PART_NM FROM PART_CD WHERE COMCD=B.COMCD AND PART_CD=B.EXBT_PARTCD) AS PART_NM,
						(SELECT EXBT_TICKET_NO FROM EXBT_TICKET_INFO WHERE EXBT_RSVN_IDX=M.EXBT_RSVN_IDX AND EXBT_TICKETSTATS='1000' 
						        /* AND ROWNUM=1 */
								LIMIT 1 
						) AS TICKET_NO
					FROM
						EXBT_RSVN_MST M , EXBT_RSVN_TIME R , EXBT_BASERULE B
					WHERE
						M.COMCD=#{comcd}
						AND M.EXBT_RSVN_IDX = R.EXBT_RSVN_IDX
						AND M.EXBT_SEQ = B.EXBT_SEQ
						AND M.EXBT_RSVN_NO = #{rsvnNum}
			) T
	</select>


	<select id="selectEvtTicketDetail" resultType="cMap">
		SELECT
			T.*,
			(SELECT COUNT(*) FROM EVT_TICKET_CHKININFO H WHERE H.COMCD=#{comcd} AND H.EVT_PARTCD=T.PART_CD AND H.EVT_TICKET_NO=T.TICKET_NO) CHK_CNT,
			(SELECT TICKET_PRN_NOTICE FROM Partcd_SystemPref WHERE COMCD=#{comcd} AND PART_CD=T.PART_CD) AS TICKET_DESC
		FROM (
			SELECT
				'EVT' AS GUBUN,
				M.EVT_RSVN_IDX AS RSVN_IDX,
				M.EVT_RSVNNO AS RSVN_NO,
				M.EVT_VEINGNMPR AS VISIT_NUM,
				M.EVT_APPDATE AS YMD,
				M.EVT_RSVN_APPTYPE AS APPTYPE,
				R.EVT_STIME AS S_TIME,
				R.EVT_ETIME AS E_TIME,
				B.EVT_NAME  AS TITLE,
				B.EVT_TICKET_NOTICE AS NOTICE_TXT,
				B.EVT_PARTCD AS PART_CD,
				'' AS TYPE_CD,
				M.EVT_RSVN_CUSTNM AS CUST_NM,
				
				<!-- for Tibero CRYPTO.Decrypt_ARIA(M.EVT_RSVN_MOBLPHON ,#{dbEnckey}) AS HP,
				CRYPTO.Decrypt_ARIA(M.EVT_EMAIL ,#{dbEnckey}) AS CUST_EMAIL, -->
				M.EVT_RSVN_MOBLPHON AS HP,
				M.EVT_EMAIL         AS CUST_EMAIL, 
				
				(SELECT PART_NM FROM PART_CD WHERE COMCD=B.COMCD AND PART_CD=B.EVT_PARTCD) AS PART_NM,
				(SELECT EVT_TICKET_NO FROM EVT_TICKET_INFO WHERE EVT_RSVN_IDX=M.EVT_RSVN_IDX AND TICKET_STATUS='1000' 
				    /* AND ROWNUM=1 */
					LIMIT 1 
				) AS TICKET_NO
			FROM
				EVT_RSVN_MST M , EVT_RSVN_TIME R , EVENT_PROGRAM B
			WHERE
				M.COMCD=#{comcd}
				AND M.EVT_RSVN_IDX = R.EVT_RSVN_IDX
				AND M.EVT_NO = B.EVT_NO
				AND M.EVT_RSVNNO = #{rsvnNum}
		) T
	</select>

</mapper>